<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>MockGPS</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #0f172a; color: #e2e8f0; overflow: hidden;
    -webkit-user-select: none; user-select: none;
}
#map { width: 100vw; height: 100vh; z-index: 1; }

/* Crosshair */
.crosshair {
    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
    z-index: 500; pointer-events: none;
}
.crosshair::before, .crosshair::after {
    content: ''; position: absolute; background: #3b82f6;
}
.crosshair::before { width: 2px; height: 28px; left: 50%; top: 50%; transform: translate(-50%, -50%); }
.crosshair::after { width: 28px; height: 2px; left: 50%; top: 50%; transform: translate(-50%, -50%); }
.crosshair-dot {
    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
    width: 8px; height: 8px; border-radius: 50%; background: #3b82f6;
    border: 2px solid #fff; z-index: 501; pointer-events: none;
    box-shadow: 0 0 8px rgba(59,130,246,0.6);
}

/* Top bar */
.top-bar {
    position: fixed; top: 0; left: 0; right: 0; z-index: 1000;
    padding: 36px 12px 8px; background: linear-gradient(to bottom, rgba(15,23,42,0.95), transparent);
}
.search-row { display: flex; gap: 8px; }
.search-input {
    flex: 1; padding: 10px 14px; border-radius: 12px;
    background: rgba(30,41,59,0.9); border: 1px solid rgba(100,116,139,0.3);
    color: #e2e8f0; font-size: 14px; outline: none;
    backdrop-filter: blur(12px);
}
.search-input:focus { border-color: #3b82f6; }
.search-input::placeholder { color: #64748b; }
.btn-search {
    padding: 10px 16px; border-radius: 12px; border: none;
    background: #3b82f6; color: white; font-size: 14px; cursor: pointer;
    font-weight: 600;
}

/* Coords display */
.coords-display {
    position: fixed; top: 92px; left: 12px; right: 12px; z-index: 1000;
    padding: 8px 14px; border-radius: 10px;
    background: rgba(15,23,42,0.85); backdrop-filter: blur(12px);
    font-size: 12px; color: #94a3b8; font-family: 'SF Mono', monospace;
    text-align: center; border: 1px solid rgba(100,116,139,0.2);
}
.coords-display span { color: #e2e8f0; font-weight: 600; }

/* Bottom panel */
.bottom-panel {
    position: fixed; bottom: 0; left: 0; right: 0; z-index: 1000;
    background: rgba(15,23,42,0.95); backdrop-filter: blur(16px);
    border-top: 1px solid rgba(100,116,139,0.2);
    border-radius: 20px 20px 0 0;
    padding: 16px 16px 28px;
    transition: transform 0.3s ease;
}
.panel-handle {
    width: 36px; height: 4px; border-radius: 2px; background: #475569;
    margin: 0 auto 12px;
}

/* Toggle */
.toggle-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
.toggle-label { font-size: 16px; font-weight: 700; }
.toggle-sublabel { font-size: 11px; color: #64748b; }
.toggle {
    width: 52px; height: 28px; border-radius: 14px; cursor: pointer;
    background: #334155; position: relative; transition: background 0.2s;
    flex-shrink: 0;
}
.toggle.active { background: #22c55e; }
.toggle-knob {
    width: 22px; height: 22px; border-radius: 11px; background: white;
    position: absolute; top: 3px; left: 3px; transition: left 0.2s;
    box-shadow: 0 1px 3px rgba(0,0,0,0.3);
}
.toggle.active .toggle-knob { left: 27px; }

/* Settings grid */
.settings-grid {
    display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px;
}
.setting-item { display: flex; flex-direction: column; gap: 2px; }
.setting-label { font-size: 10px; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; }
.setting-input {
    padding: 8px 10px; border-radius: 8px;
    background: rgba(30,41,59,0.8); border: 1px solid rgba(100,116,139,0.3);
    color: #e2e8f0; font-size: 13px; outline: none; width: 100%;
}
.setting-input:focus { border-color: #3b82f6; }

/* Buttons */
.btn-row { display: flex; gap: 8px; }
.btn-set {
    flex: 1; padding: 12px; border-radius: 12px; border: none;
    background: #3b82f6; color: white; font-size: 15px;
    font-weight: 700; cursor: pointer; letter-spacing: 0.3px;
}
.btn-set:active { background: #2563eb; }
.btn-set.danger { background: #ef4444; }
.btn-set.danger:active { background: #dc2626; }
.btn-secondary {
    padding: 12px 16px; border-radius: 12px; border: 1px solid rgba(100,116,139,0.3);
    background: rgba(30,41,59,0.8); color: #e2e8f0; font-size: 14px; cursor: pointer;
}

/* Status indicator */
.status-dot {
    display: inline-block; width: 8px; height: 8px; border-radius: 50%;
    margin-right: 6px; background: #ef4444;
}
.status-dot.active { background: #22c55e; animation: pulse 2s infinite; }
@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

/* My location button */
.btn-myloc {
    position: fixed; right: 12px; z-index: 999; width: 44px; height: 44px;
    border-radius: 12px; border: none; background: rgba(15,23,42,0.9);
    backdrop-filter: blur(12px); color: #e2e8f0; font-size: 20px; cursor: pointer;
    border: 1px solid rgba(100,116,139,0.3);
    display: flex; align-items: center; justify-content: center;
}
.btn-myloc { bottom: 280px; }

/* Search results */
.search-results {
    position: fixed; top: 82px; left: 12px; right: 12px; z-index: 1001;
    background: rgba(15,23,42,0.95); backdrop-filter: blur(12px);
    border-radius: 12px; border: 1px solid rgba(100,116,139,0.3);
    max-height: 200px; overflow-y: auto; display: none;
}
.search-result {
    padding: 10px 14px; border-bottom: 1px solid rgba(100,116,139,0.1);
    font-size: 13px; cursor: pointer;
}
.search-result:hover, .search-result:active { background: rgba(59,130,246,0.2); }
.search-result:last-child { border-bottom: none; }

/* Dev options toggle */
.dev-row {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 12px; padding: 8px 0;
    border-bottom: 1px solid rgba(100,116,139,0.15);
}

/* Toast notification */
.toast {
    position: fixed; bottom: 320px; left: 50%; transform: translateX(-50%);
    background: rgba(30,41,59,0.95); color: #e2e8f0; padding: 10px 20px;
    border-radius: 10px; font-size: 13px; z-index: 2000;
    border: 1px solid rgba(100,116,139,0.3);
    opacity: 0; transition: opacity 0.3s; pointer-events: none;
}
.toast.show { opacity: 1; }
</style>
</head>
<body>

<div id="map"></div>
<div class="crosshair"></div>
<div class="crosshair-dot"></div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Top bar -->
<div class="top-bar">
    <div class="search-row">
        <input type="text" class="search-input" id="searchInput"
               placeholder="Search location..." autocomplete="off">
        <button class="btn-search" onclick="searchLocation()">Search</button>
    </div>
</div>

<div class="coords-display" id="coordsDisplay">
    <span id="latDisplay">0.000000</span>, <span id="lngDisplay">0.000000</span>
</div>

<div class="search-results" id="searchResults"></div>

<!-- My location button -->
<button class="btn-myloc" onclick="goToMyLocation()">+</button>

<!-- Bottom panel -->
<div class="bottom-panel" id="bottomPanel">
    <div class="panel-handle"></div>

    <!-- GPS Toggle -->
    <div class="toggle-row">
        <div>
            <div class="toggle-label">
                <span class="status-dot" id="statusDot"></span>
                GPS Spoofing
            </div>
            <div class="toggle-sublabel" id="statusText">Disabled</div>
        </div>
        <div class="toggle" id="toggleGPS" onclick="toggleGPS()">
            <div class="toggle-knob"></div>
        </div>
    </div>

    <!-- Dev Options Toggle -->
    <div class="dev-row">
        <div>
            <div style="font-size:13px; font-weight:600;">Hide Developer Options</div>
            <div style="font-size:10px; color:#64748b;">mock_location, dev settings, adb</div>
        </div>
        <div class="toggle active" id="toggleDev" onclick="toggleDev()">
            <div class="toggle-knob"></div>
        </div>
    </div>

    <!-- Settings -->
    <div class="settings-grid">
        <div class="setting-item">
            <span class="setting-label">Accuracy (m)</span>
            <input type="number" class="setting-input" id="inputAccuracy" value="3.0" step="0.5">
        </div>
        <div class="setting-item">
            <span class="setting-label">Altitude (m)</span>
            <input type="number" class="setting-input" id="inputAltitude" value="0" step="1">
        </div>
        <div class="setting-item">
            <span class="setting-label">Speed (m/s)</span>
            <input type="number" class="setting-input" id="inputSpeed" value="0" step="0.5">
        </div>
        <div class="setting-item">
            <span class="setting-label">Bearing</span>
            <input type="number" class="setting-input" id="inputBearing" value="0" step="1" min="0" max="360">
        </div>
    </div>

    <!-- Buttons -->
    <div class="btn-row">
        <button class="btn-set" id="btnSet" onclick="setLocation()">Set Location</button>
    </div>
</div>

<script>
// KernelSU exec helper
const CONFIG_PATH = '/data/adb/modules/mockgps/location.conf';

function execCommand(command) {
    return new Promise((resolve, reject) => {
        const callbackName = 'exec_callback_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
        window[callbackName] = function(errno, stdout, stderr) {
            delete window[callbackName];
            if (errno === 0) {
                resolve(stdout || '');
            } else {
                reject(stderr || 'Command failed with error code ' + errno);
            }
        };
        if (typeof ksu !== 'undefined' && ksu.exec) {
            ksu.exec(command, '{}', callbackName);
        } else {
            reject('KSU API not available');
        }
    });
}

// Toast
let toastTimer = null;
function showToast(msg) {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.classList.add('show');
    if (toastTimer) clearTimeout(toastTimer);
    toastTimer = setTimeout(() => el.classList.remove('show'), 2500);
}

// State
let gpsEnabled = false;
let devHideEnabled = true;
let currentMarker = null;

// Initialize map
const map = L.map('map', {
    center: [10.7769, 106.7009],
    zoom: 13,
    zoomControl: false,
    attributionControl: false
});

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19
}).addTo(map);

// Update coords display on move
map.on('move', function() {
    const c = map.getCenter();
    document.getElementById('latDisplay').textContent = c.lat.toFixed(6);
    document.getElementById('lngDisplay').textContent = c.lng.toFixed(6);
});

setTimeout(() => map.fire('move'), 100);

// Search location via Nominatim
function searchLocation() {
    const query = document.getElementById('searchInput').value.trim();
    if (!query) return;

    const resultsDiv = document.getElementById('searchResults');
    resultsDiv.innerHTML = '<div class="search-result" style="color:#64748b">Searching...</div>';
    resultsDiv.style.display = 'block';

    fetch('https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(query) + '&limit=5')
    .then(r => r.json())
    .then(results => {
        if (!results.length) {
            resultsDiv.innerHTML = '<div class="search-result" style="color:#64748b">No results found</div>';
            return;
        }
        resultsDiv.innerHTML = '';
        results.forEach(r => {
            const div = document.createElement('div');
            div.className = 'search-result';
            div.textContent = r.display_name;
            div.onclick = () => {
                map.setView([parseFloat(r.lat), parseFloat(r.lon)], 16);
                resultsDiv.style.display = 'none';
                document.getElementById('searchInput').value = '';
            };
            resultsDiv.appendChild(div);
        });
    })
    .catch(() => {
        resultsDiv.innerHTML = '<div class="search-result" style="color:#ef4444">Search failed</div>';
    });
}

document.getElementById('searchInput').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') searchLocation();
});

map.on('click', () => {
    document.getElementById('searchResults').style.display = 'none';
});

// Toggle GPS
function toggleGPS() {
    gpsEnabled = !gpsEnabled;
    updateToggleUI();
    saveAndApply();
}

// Toggle Dev options hide
function toggleDev() {
    devHideEnabled = !devHideEnabled;
    const el = document.getElementById('toggleDev');
    el.classList.toggle('active', devHideEnabled);
    saveAndApply();
}

function updateToggleUI() {
    const toggle = document.getElementById('toggleGPS');
    const dot = document.getElementById('statusDot');
    const text = document.getElementById('statusText');

    toggle.classList.toggle('active', gpsEnabled);
    dot.classList.toggle('active', gpsEnabled);
    text.textContent = gpsEnabled ? 'Active - Location spoofed' : 'Disabled';
}

// Set location
function setLocation() {
    const c = map.getCenter();

    if (currentMarker) map.removeLayer(currentMarker);

    currentMarker = L.circleMarker([c.lat, c.lng], {
        radius: 8, fillColor: '#3b82f6', fillOpacity: 1,
        color: '#fff', weight: 2
    }).addTo(map);

    if (!gpsEnabled) {
        gpsEnabled = true;
        updateToggleUI();
    }

    saveAndApply();
    showToast('Location set: ' + c.lat.toFixed(6) + ', ' + c.lng.toFixed(6));
}

// Save config via ksu.exec
function saveAndApply() {
    const c = currentMarker ? currentMarker.getLatLng() : map.getCenter();

    const config = [
        'enabled=' + (gpsEnabled ? '1' : '0'),
        'lat=' + c.lat.toFixed(8),
        'lng=' + c.lng.toFixed(8),
        'accuracy=' + (document.getElementById('inputAccuracy').value || '3.0'),
        'altitude=' + (document.getElementById('inputAltitude').value || '0'),
        'speed=' + (document.getElementById('inputSpeed').value || '0'),
        'bearing=' + (document.getElementById('inputBearing').value || '0'),
        'hidedev=' + (devHideEnabled ? '1' : '0')
    ].join('\n');

    const escaped = config.replace(/'/g, "'\\''");
    execCommand("echo '" + escaped + "' > " + CONFIG_PATH + " && chmod 644 " + CONFIG_PATH)
        .then(() => {})
        .catch(err => showToast('Save failed: ' + err));
}

// Go to real location
function goToMyLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            pos => map.setView([pos.coords.latitude, pos.coords.longitude], 16),
            () => showToast('Location unavailable')
        );
    }
}

// Load config from module on startup
function loadConfig(cfg) {
    if (cfg.lat && cfg.lng && (cfg.lat !== 0 || cfg.lng !== 0)) {
        map.setView([cfg.lat, cfg.lng], 16);
        if (currentMarker) map.removeLayer(currentMarker);
        currentMarker = L.circleMarker([cfg.lat, cfg.lng], {
            radius: 8, fillColor: '#3b82f6', fillOpacity: 1,
            color: '#fff', weight: 2
        }).addTo(map);
    }

    gpsEnabled = cfg.enabled === 1 || cfg.enabled === '1';
    updateToggleUI();

    if (cfg.accuracy !== undefined) document.getElementById('inputAccuracy').value = cfg.accuracy;
    if (cfg.altitude !== undefined) document.getElementById('inputAltitude').value = cfg.altitude;
    if (cfg.speed !== undefined) document.getElementById('inputSpeed').value = cfg.speed;
    if (cfg.bearing !== undefined) document.getElementById('inputBearing').value = cfg.bearing;

    if (cfg.hidedev !== undefined) {
        devHideEnabled = cfg.hidedev === 1 || cfg.hidedev === '1';
        document.getElementById('toggleDev').classList.toggle('active', devHideEnabled);
    }
}

// Read config on page load
async function initConfig() {
    try {
        const raw = await execCommand('cat ' + CONFIG_PATH + ' 2>/dev/null');
        if (raw && raw.trim()) {
            const cfg = {};
            raw.trim().split('\n').forEach(line => {
                const parts = line.split('=', 2);
                if (parts.length === 2) {
                    const key = parts[0].trim();
                    const val = parts[1].trim();
                    if (key === 'enabled' || key === 'hidedev') {
                        cfg[key] = parseInt(val);
                    } else {
                        cfg[key] = parseFloat(val);
                    }
                }
            });
            loadConfig(cfg);
        }
    } catch (e) {
        // Config doesn't exist yet or KSU API not ready
    }
}

// Init
setTimeout(initConfig, 300);
</script>
</body>
</html>
